<!doctype HTML>
<html lang="en">
<head>
    <title>Cut down database imports by a third using this one weird trick</title>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="//www.californiacivicdata.org/favicon.png">

<link type="text/css" rel="stylesheet" href="/css/bootstrap.min.css">

<link rel="stylesheet" type="text/css" href="//calaccess.californiacivicdata.org/static/calaccess_website/css/sourcesanspro.css">
<link rel="stylesheet" type="text/css" href="//calaccess.californiacivicdata.org/static/calaccess_website/css/main.css?foobar">

<link type="text/css" rel="stylesheet" href="/css/font-awesome.min.css">
<link href="//fonts.googleapis.com/css?family=Raleway:400,600" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="/css/blog.css">

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/bootstrap.js"></script>
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55129934-1', 'auto');
  ga('send', 'pageview');

</script>

    <meta name="date" content="2018-01-25 00:00:00 +0000" />

    <meta property="og:site_name" content="www.californiacivicdata.org"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Cut down database imports by a third using this one weird trick"/>
    <meta property="og:image" content="http://www.californiacivicdata.org/img/postgres-copy-index-scatter-two.png"/>
    <meta property="og:description" content="Our open-source bulk loader for PostgreSQL is faster than ever"/>

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:image:src" content="http://www.californiacivicdata.org/img/postgres-copy-index-scatter-two.png">
    <meta property="twitter:site" content="@latimes">
    <meta property="twitter:title" content="Cut down database imports by a third using this one weird trick">
    <meta property="twitter:description" content="Our open-source bulk loader for PostgreSQL is faster than ever"/>
    <meta property="twitter:image" content="http://www.californiacivicdata.org/img/postgres-copy-index-scatter-two.png" />
    <link rel="image_src" type="image/jpeg" href="http://www.californiacivicdata.org/img/postgres-copy-index-scatter-two.png" />
</head>
<body>
    <header>
  <nav class="container">
    <div class="row">
    <div class="col-md-12">
      <ul class="nav nav-pills">
        <li class="visible-lg-inline visible-md-inline visible-sm-inline invisible-xs-inline" style="margin-left:0;">
            <a class="logo" href="https://www.californiacivicdata.org/">
                <img
                    src="//calaccess.californiacivicdata.org/static/calaccess_website/images/brown-geobear.svg"
                    alt="California Civic Data Coalition logo"
                    title="Home"
                >
            </a>
        </li>
        <li id="home"><a href="/">HOME</a></li>
        <li id="data"><a href="https://calaccess.californiacivicdata.org/downloads/latest/">DATA</a></li>
        <li id="docs"><a href="https://calaccess.californiacivicdata.org/documentation/">DOCS</a></li>
        <li id="blog"><a href="/archive/">BLOG</a></li>
        <li id="about"><a href="/about/">ABOUT</a></li>
      </ul>
    </div>
    </div>
  </nav>
</header>

<script type="text/javascript">
    var url = window.location;
    // Will only work if string in href matches with location
    $('ul.nav a[href="' + url + '"]').parent().addClass('active');
    // Will also work for relative and absolute hrefs
    $('ul.nav a').filter(function() {
        return this.href == url;
    }).parent().addClass('active');
    $("#small-icon").css("cursor", "pointer");
    $("#small-icon").click(function () {
        window.location = '/';
    });
</script>

    <article>
    <div class="bg-red">
        <div class="container">
            <div class="row">
                <nav class="col-md-9">
                    <ol class="breadcrumb">
                        <li><a href="/">Home</a></li>
                        <li><a href="/archive/">Blog</a></li>
                    </ol>
                </nav>
                <div class="col-md-9">
                    <h1>Cut down database imports by a third using this one weird trick</h1>
                    <p>
                        <p>Our open-source bulk loader for PostgreSQL is faster than ever</p>

                    </p>
                    <div class="byline"><p>By <a href="http://palewi.re/who-is-ben-welsh/">Ben Welsh</a></p>
</div>
                <div class="pubdate"><p><time datetime="2018-01-25">January 25, 2018</time></p></div>
                </div>
            </div>
        </div>
    </div>
    <div class="container content">
        <div class="row">
            <div class="post col-lg-8 col-md-10 col-sm-12 col-xs-12">
                <p>Today the California Civic Data Coalition released a powerful improvement to its open-source tool for importing data via the Django web framework.</p>

<p>Version 2.2 of <a href="http://django-postgres-copy.californiacivicdata.org/en/latest/">django-postgres-copy</a>, now available on the Python Package Index, boosts the performance of PostgreSQL’s <a href="https://www.postgresql.org/docs/9.2/static/sql-copy.html">COPY</a> command by automatically dropping indexes and constraints on tables prior to the loading.</p>

<p>The result is significantly faster ingestion. Our speed tests – using tens of millions of state records – found the change reduced load time of large tables <em>by nearly one third</em>.</p>

<p>After data are safely loaded, indexes and constraints are restored to the database.</p>

<p>Current users of django-postgres-copy can benefit simply by upgrading. No code changes are necessary.</p>

<p>If you’re unfamiliar with our library, all you have to do is hook our custom manager to your database model and loading from a comma-delimited file becomes this easy:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">MyModel</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">from_csv</span><span class="p">(</span><span class="s">"/path/to/your/import.csv"</span><span class="p">)</span></code></pre></figure>

<h3 id="why-we-did-it">Why we did it</h3>

<p>This improvement was pioneered by <a href="https://twitter.com/je_gordon">James Gordon</a>, the Coalition’s lead developer.</p>

<p>He drew instruction from PostgreSQL’s official documentation, <a href="https://www.postgresql.org/docs/10/static/populate.html">which reads</a>:</p>

<blockquote>
  <p>If you are loading a freshly created table, the fastest method is to create the table, bulk load the table’s data using COPY, then create any indexes needed for the table. Creating an index on pre-existing data is quicker than updating it incrementally as each row is loaded.</p>
</blockquote>

<blockquote>
  <p>If you are adding large amounts of data to an existing table, it might be a win to drop the indexes, load the table, and then recreate the indexes.</p>
</blockquote>

<p><a href="https://github.com/california-civic-data-coalition/django-postgres-copy/blob/3d7fa390b16c2ded087b206fa7ba9cdd378a415d/postgres_copy/managers.py#L12-L123">Gordon’s code</a> handles this task using rarely utilized, low-level tools in Django’s database manager.</p>

<h3 id="what-to-expect">What to expect</h3>

<p>Our speed tests were conducted in a Jupyter Notebook <a href="https://github.com/california-civic-data-coalition/python-calaccess-notebooks/blob/master/calaccess-exploration/django-postgres-copy%20speed%20tests.ipynb">now available on GitHub</a>. There you can see Python’s <a href="https://docs.python.org/2/library/timeit.html">timeit</a> module load 41 million records from CAL-ACCESS, the state of California’s jumbled, dirty and difficult database tracking money in politics.</p>

<p>Each table was loaded three times with the indexes left in place, and then three times with all indexes dropped prior to loading.</p>

<p>The results were clear. Total load time dropped from 21 minutes and 9 seconds with indexes to just 14 minutes and 31 seconds without. That’s a decrease of 31%.</p>

<p>Closer examination of the results shows that the bigger the table, the larger the savings. The chart below compares table size with reductions in load time. As you can see, the biggest tables scored the biggest gains.</p>

<figure style="width: 100%; margin: 20px 0; padding:0;">
    <img src="/img/postgres-copy-index-scatter-one.png" style="padding: 10px" />
</figure>

<p>That said, not every table improved. Small tables sometimes saw a decrease in speed, likely due to the extra time needed to drop and restore the indexes. Our analysis found that gains were not guaranteed until tables approached 20,000 rows in length.</p>

<p>You can see that result in the next chart, which compares each table’s row count against its <em>percentage change</em> in load time. That puts more emphasis on shifts seen by smaller tables.</p>

<figure style="width: 100%; margin: 20px 0; padding:0;">
    <img src="/img/postgres-copy-index-scatter-two.png" style="padding: 10px" />
</figure>

<p>However, tables under 20,000 records loaded so quickly lags were negligible. And if you’d prefer to opt out of our new feature, you can always do so with the following keyword arguments:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">MyModel</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">from_csv</span><span class="p">(</span>
    <span class="s">"/path/to/your/import.csv"</span><span class="p">,</span>
    <span class="n">drop_indexes</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">drop_constraints</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span></code></pre></figure>

<p>As always, you mileage may vary. An obvious factor not tested here is the number and complexity of indexes and constraints on the database. Ours has two or three on most tables.</p>

<p>To learn more about how django-postgres-copy works, visit the <a href="http://django-postgres-copy.californiacivicdata.org/">technical documentation</a>. There you’ll find a more complete explanation and information about tricks not covered here, like the recently-added ability to export tables.</p>

<p>Since django-postgres-copy was <a href="https://www.californiacivicdata.org/2015/07/17/hello-django-postgres-copy/">first released</a> in 2015, it has drawn contributions from coders around the world, including some major improvements <a href="https://www.californiacivicdata.org/2016/11/14/django-postgres-copy-0.1/">from users in other fields</a>. If there are improvements you’d like to see, go get involved on <a href="https://github.com/california-civic-data-coalition/django-postgres-copy">our GitHub repository</a>.</p>

            <script type="text/javascript">
                var url = window.location;
                // Will only work if string in href matches with location
                $('ul.nav a[href="/archive/"]').parent().addClass('active');
                // Will also work for relative and absolute hrefs
                $('ul.nav a').filter(function() {
                    return this.href == url;
                }).parent().addClass('active');
                $("#small-icon").css("cursor", "pointer");
                $("#small-icon").click(function () {
                    window.location = '/';
                });
            </script>
            </div>
        </div>
    </div>
    </article>
    <footer class="footer" aria-label="Footer">
  <nav class="container">
    <div class="row icon">
      <a href="http://www.californiacivicdata.org/">
        <img src="//calaccess.californiacivicdata.org/static/calaccess_website/images/white-geobear.svg"
             alt="California Civic Data Coalition logo">
      </a>
    </div>
    <div class="row">
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-5 col-xs-offset-1">
        <h3>CAL-ACCESS</h3>
        <ul>
            <li><a href="http://calaccess.californiacivicdata.org/downloads/latest/">Latest downloads</a></li>
            <li><a href="http://calaccess.californiacivicdata.org/downloads/">Downloads archive</a></li>
            <li><a href="http://calaccess.californiacivicdata.org/documentation/">Documentation</a></li>
        </ul>
      </section>
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-4 col-xs-offset-2">
        <h3>Blog</h3>
        <ul>
          <li><a href="http://www.californiacivicdata.org/archive/">All posts</a></li>
          <li><a href="http://www.californiacivicdata.org/archive/latest.xml">RSS</a></li>
        </ul>
      </section>
      <div class="clearfix visible-sm visible-xs"></div>
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-5 col-xs-offset-1">
        <h3>About</h3>
        <ul>
          <li><a href="https://www.californiacivicdata.org/about/">Our story</a></li>
          <li><a href="https://www.californiacivicdata.org/about/#team">The team</a></li>
          <li><a href="https://www.californiacivicdata.org/about/#events">Events</a></li>
          <li><a href="https://www.californiacivicdata.org/about/#what-others-are-saying">What others are saying</a></li>
        </ul>
      </section>
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-4 col-xs-offset-2">
        <h3>Contact</h3>
        <ul>
          <li><a href="mailto:cacivicdata@gmail.com">E-mail</a></li>
          <li><a href="https://github.com/california-civic-data-coalition">GitHub</a></li>
          <li><a href="https://newsnerdery.slack.com/archives/C0H8Y2QBD">Slack</a></li>
        </ul>
      </section>
    </div>
    <section class="row xs-left">
      <p>
        &copy; <span class="easteregg"><a href="https://www.youtube.com/watch?v=wPsA3TsK1Uk">2016 'til infinity</a></span>
        <span><a href="https://www.californiacivicdata.org/">California Civic Data Coalition</a>.</span>
        <span><span class="easteregg"><a href="https://en.wikipedia.org/wiki/Gratis_versus_libre">Gratis, libre and fermented</a></span> on <a href="https://github.com/california-civic-data-coalition/">GitHub</a>.</span>
        <span class="easteregg"><a href="https://www.youtube.com/watch?v=wKgGXxoT5Ds">Westside right on time only thing fosho</a>.</span>
      </p>
    </section>
  </nav>
</footer>

</body>
</html>
