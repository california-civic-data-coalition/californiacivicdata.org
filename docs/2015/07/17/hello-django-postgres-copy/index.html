<!doctype HTML>
<html lang="en">
<head>
    <title>Say hello to our new open-source software for loading bulk data into PostgreSQL</title>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="//www.californiacivicdata.org/favicon.png">

<link type="text/css" rel="stylesheet" href="/css/bootstrap.min.css">

<link rel="stylesheet" type="text/css" href="//calaccess.californiacivicdata.org/static/calaccess_website/css/sourcesanspro.css">
<link rel="stylesheet" type="text/css" href="//calaccess.californiacivicdata.org/static/calaccess_website/css/main.css?foobar">

<link type="text/css" rel="stylesheet" href="/css/font-awesome.min.css">
<link href="//fonts.googleapis.com/css?family=Raleway:400,600" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="/css/blog.css">

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/bootstrap.js"></script>
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55129934-1', 'auto');
  ga('send', 'pageview');

</script>

    <meta name="date" content="2015-07-17 00:00:00 +0000" />

    <meta property="og:site_name" content="www.californiacivicdata.org"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Say hello to our new open-source software for loading bulk data into PostgreSQL"/>
    <meta property="og:image" content="http://calaccess.californiacivicdata.org/static/calaccess_website/images/brown-bear-share.png"/>
    <meta property="og:description" content="Take advantage of powerful COPY command to load big CSVs into Django faster than ever"/>

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:image:src" content="http://calaccess.californiacivicdata.org/static/calaccess_website/images/brown-bear-share.png">
    <meta property="twitter:site" content="@latimes">
    <meta property="twitter:title" content="Say hello to our new open-source software for loading bulk data into PostgreSQL">
    <meta property="twitter:description" content="Take advantage of powerful COPY command to load big CSVs into Django faster than ever"/>
    <meta property="twitter:image" content="http://calaccess.californiacivicdata.org/static/calaccess_website/images/brown-bear-share.png" />
    <link rel="image_src" type="image/jpeg" href="http://calaccess.californiacivicdata.org/static/calaccess_website/images/brown-bear-share.png" />
</head>
<body>
    <header>
  <nav class="container">
    <div class="row">
    <div class="col-md-12">
      <ul class="nav nav-pills">
        <li class="visible-lg-inline visible-md-inline visible-sm-inline invisible-xs-inline" style="margin-left:0;">
            <a class="logo" href="https://www.californiacivicdata.org/">
                <img
                    src="//calaccess.californiacivicdata.org/static/calaccess_website/images/brown-geobear.svg"
                    alt="California Civic Data Coalition logo"
                    title="Home"
                >
            </a>
        </li>
        <li id="home"><a href="/">HOME</a></li>
        <li id="data"><a href="https://calaccess.californiacivicdata.org/downloads/latest/">DATA</a></li>
        <li id="docs"><a href="https://calaccess.californiacivicdata.org/documentation/">DOCS</a></li>
        <li id="blog"><a href="/archive/">BLOG</a></li>
        <li id="about"><a href="/about/">ABOUT</a></li>
      </ul>
    </div>
    </div>
  </nav>
</header>

<script type="text/javascript">
    var url = window.location;
    // Will only work if string in href matches with location
    $('ul.nav a[href="' + url + '"]').parent().addClass('active');
    // Will also work for relative and absolute hrefs
    $('ul.nav a').filter(function() {
        return this.href == url;
    }).parent().addClass('active');
    $("#small-icon").css("cursor", "pointer");
    $("#small-icon").click(function () {
        window.location = '/';
    });
</script>

    <article>
    <div class="bg-red">
        <div class="container">
            <div class="row">
                <nav class="col-md-9">
                    <ol class="breadcrumb">
                        <li><a href="/">Home</a></li>
                        <li><a href="/archive/">Blog</a></li>
                    </ol>
                </nav>
                <div class="col-md-9">
                    <h1>Say hello to our new open-source software for loading bulk data into PostgreSQL</h1>
                    <p>
                        <p>Take advantage of powerful COPY command to load big CSVs into Django faster than ever</p>

                    </p>
                    <div class="byline"><p>By <a href="http://palewi.re/who-is-ben-welsh/">Ben Welsh</a></p>
</div>
                <div class="pubdate"><p><time datetime="2015-07-17">July 17, 2015</time></p></div>
                </div>
            </div>
        </div>
    </div>
    <div class="container content">
        <div class="row">
            <div class="post col-lg-8 col-md-10 col-sm-12 col-xs-12">
                <p>This morning we’re releasing a new open-source software library that allows users of the Django web framework to more quickly load comma-delimited data into PostgreSQL databases.</p>

<p><strong>django-postgres-copy</strong>, a new wrapper on the database’s powerful <a href="http://www.postgresql.org/docs/9.4/static/sql-copy.html">COPY</a> command, is now published on <a href="https://github.com/california-civic-data-coalition/django-postgres-copy">GitHub</a> and packaged for installation in the <a href="https://pypi.python.org/pypi/django-postgres-copy">Python Package Index</a>. Technical documentation has been published via <a href="http://django-postgres-copy.californiacivicdata.org/">ReadTheDocs</a>.</p>

<h3 id="why-and-what-for">Why and what for?</h3>

<p>Our work as data journalists often calls on us to download, clean and analyze new data sets. That means we write a load of loaders.</p>

<p>And since we code with <a href="https://www.djangoproject.com/">Django</a>, we write a lot of Python scripts that loop through each row in a spreadsheet and drop the data into a database.</p>

<p>Scripts that look something like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">csv</span>  <span class="c1"># Import our toys
</span><span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">MyModel</span>

<span class="c1"># Open up the CSV file
</span><span class="n">data</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">DictReader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">"./data.csv"</span><span class="p">))</span>
<span class="c1"># Loop through it
</span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="c1"># Save each record to the database
</span>    <span class="n">MyModel</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s">'NAME'</span><span class="p">],</span> <span class="n">number</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s">'NUMBER'</span><span class="p">])</span></code></pre></figure>

<p>But if you have a big CSV, Django will rack up database queries and it can take a long time to finish.</p>

<p>Lucky for us, PostgreSQL has a built-in tool called COPY that can hammer data into the database with one quick query. The only problem: Django doesn’t support it.</p>

<p>This package tries to make using COPY as easy any other database routine accessible with Django. It is largely based on the design of the <a href="https://docs.djangoproject.com/en/1.8/ref/contrib/gis/layermapping/">LayerMapping</a> utility for importing geospatial data.</p>

<p>Once you have our code hooked up, your loader can look more like this.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">MyModel</span>
<span class="kn">from</span> <span class="nn">postgres_copy</span> <span class="kn">import</span> <span class="n">CopyMapping</span>  <span class="c1"># Import it here
</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">CopyMapping</span><span class="p">(</span>
    <span class="c1"># Provide your database table's model
</span>    <span class="n">MyModel</span><span class="p">,</span>
    <span class="c1"># Your CSV data file
</span>    <span class="s">"./data.csv"</span><span class="p">,</span>
    <span class="c1"># And a map between the model fields and CSV column headers
</span>    <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'NAME'</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="s">'NUMBER'</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># And fire away!
</span><span class="n">c</span><span class="p">.</span><span class="n">save</span><span class="p">()</span></code></pre></figure>

<p>That may not seem like much difference, but the performance gains can be huge.</p>

<h3 id="how-huge">How huge?</h3>

<p>As an experiment, we tested two common CSV loading patterns against our new tool using the political campaign expenditure file published as part of the California Secretary of State’s CAL-ACCESS database, which is the main focus of <a href="http://www.californiacivicdata.org/2014/09/24/hello-world/">our coalition</a>.</p>

<p>With 4.5 million records spread across dozens of columns, the file fills 1.3 gigabytes of hard drive space. That’s not <a href="https://en.wikipedia.org/wiki/Big_data">“big data”</a> by any formal definition, but it’s big enough to bring the laptop of your average hack journalist grinding to a halt.</p>

<p>(This size falls into a zone we think of as “medium data:” Too big and complex to be managable in Excel, but not so big that it requires heavy duty tools like <a href="https://hadoop.apache.org/">Hadoop</a>. In our opinion, this area is in critical need of better software to help analysts get a foothold.)</p>

<p>In the first test, we timed a simple loop like the one above that stepped through each row in the data file and loaded records into the database one by one. By design, Django will ferry each row into the database individually. This adds up quickly.</p>

<p>On our test machine, a three-year-old Lenovo ThinkPad x220, it took <strong>1 hour and 23 minutes</strong> to complete.</p>

<p>In the second test, we reorganized our script to lump the rows into groups of 1,000 records. Along the way we used Django’s <a href="https://docs.djangoproject.com/en/1.8/ref/models/querysets/#bulk-create">bulk_create</a> command to drop those groups into the database as large batches.</p>

<p>By reducing the number of database queries, this second test finished in <strong>18 minutes</strong>.</p>

<p>In our final test, we loaded the file using our wrapper on the COPY command. It finished in just <strong>4 minutes and 45 seconds</strong>. Now imagine how much faster it would
be if it wasn’t running on a three-year-old ThinkPad.</p>

<h3 id="what-now">What now?</h3>

<p>If you’d like to try our tool out for yourself, you can install it with Python’s <code class="language-plaintext highlighter-rouge">pip</code> like so:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>pip <span class="nb">install </span>django-postgres-copy</code></pre></figure>

<p>To learn more about how it works, visit the <a href="http://django-postgres-copy.californiacivicdata.org/">technical documentation</a>. There you’ll find more a complete explanation and information about some fancier tricks not covered here, like the capability to transform and clean data on-the-fly as it’s loaded into the database.</p>

<p>We’ve already integrated the tool into <a href="http://django-calaccess-raw-data.californiacivicdata.org/">django-calaccess-raw-data</a>, a Django app to download, extract and load campaign finance and lobbying activity data from the CAL-ACCESS database.</p>

<p>This project is experimental and in the early stages of development. The aim is to
make it easier for others to load “medium data.” But we know
our code isn’t perfect and we want for feedback from hackers like you to make it better. So break it. Please. <a href="https://github.com/california-civic-data-coalition/django-postgres-copy/issues">Then let us know</a>.</p>

            <script type="text/javascript">
                var url = window.location;
                // Will only work if string in href matches with location
                $('ul.nav a[href="/archive/"]').parent().addClass('active');
                // Will also work for relative and absolute hrefs
                $('ul.nav a').filter(function() {
                    return this.href == url;
                }).parent().addClass('active');
                $("#small-icon").css("cursor", "pointer");
                $("#small-icon").click(function () {
                    window.location = '/';
                });
            </script>
            </div>
        </div>
    </div>
    </article>
    <footer class="footer" aria-label="Footer">
  <nav class="container">
    <div class="row icon">
      <a href="http://www.californiacivicdata.org/">
        <img src="//calaccess.californiacivicdata.org/static/calaccess_website/images/white-geobear.svg"
             alt="California Civic Data Coalition logo">
      </a>
    </div>
    <div class="row">
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-5 col-xs-offset-1">
        <h3>CAL-ACCESS</h3>
        <ul>
            <li><a href="http://calaccess.californiacivicdata.org/downloads/latest/">Latest downloads</a></li>
            <li><a href="http://calaccess.californiacivicdata.org/downloads/">Downloads archive</a></li>
            <li><a href="http://calaccess.californiacivicdata.org/documentation/">Documentation</a></li>
        </ul>
      </section>
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-4 col-xs-offset-2">
        <h3>Blog</h3>
        <ul>
          <li><a href="http://www.californiacivicdata.org/archive/">All posts</a></li>
          <li><a href="http://www.californiacivicdata.org/archive/latest.xml">RSS</a></li>
        </ul>
      </section>
      <div class="clearfix visible-sm visible-xs"></div>
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-5 col-xs-offset-1">
        <h3>About</h3>
        <ul>
          <li><a href="https://www.californiacivicdata.org/about/">Our story</a></li>
          <li><a href="https://www.californiacivicdata.org/about/#team">The team</a></li>
          <li><a href="https://www.californiacivicdata.org/about/#events">Events</a></li>
          <li><a href="https://www.californiacivicdata.org/about/#what-others-are-saying">What others are saying</a></li>
        </ul>
      </section>
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-4 col-xs-offset-2">
        <h3>Contact</h3>
        <ul>
          <li><a href="mailto:cacivicdata@gmail.com">E-mail</a></li>
          <li><a href="https://github.com/california-civic-data-coalition">GitHub</a></li>
          <li><a href="https://newsnerdery.slack.com/archives/C0H8Y2QBD">Slack</a></li>
        </ul>
      </section>
    </div>
    <section class="row xs-left">
      <p>
        &copy; <span class="easteregg"><a href="https://www.youtube.com/watch?v=wPsA3TsK1Uk">2016 'til infinity</a></span>
        <span><a href="https://www.californiacivicdata.org/">California Civic Data Coalition</a>.</span>
        <span><span class="easteregg"><a href="https://en.wikipedia.org/wiki/Gratis_versus_libre">Gratis, libre and fermented</a></span> on <a href="https://github.com/california-civic-data-coalition/">GitHub</a>.</span>
        <span class="easteregg"><a href="https://www.youtube.com/watch?v=wKgGXxoT5Ds">Westside right on time only thing fosho</a>.</span>
      </p>
    </section>
  </nav>
</footer>

</body>
</html>
