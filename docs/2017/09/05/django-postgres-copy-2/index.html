<!doctype HTML>
<html lang="en">
<head>
    <title>How to export Django data faster than ever before</title>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="//www.californiacivicdata.org/favicon.png">

<link type="text/css" rel="stylesheet" href="/css/bootstrap.min.css">

<link rel="stylesheet" type="text/css" href="//calaccess.californiacivicdata.org/static/calaccess_website/css/sourcesanspro.css">
<link rel="stylesheet" type="text/css" href="//calaccess.californiacivicdata.org/static/calaccess_website/css/main.css?foobar">

<link type="text/css" rel="stylesheet" href="/css/font-awesome.min.css">
<link href="//fonts.googleapis.com/css?family=Raleway:400,600" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="/css/blog.css">

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/bootstrap.js"></script>
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55129934-1', 'auto');
  ga('send', 'pageview');

</script>

    <meta name="date" content="2017-09-05 00:00:00 +0000" />

    <meta property="og:site_name" content="www.californiacivicdata.org"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="How to export Django data faster than ever before"/>
    <meta property="og:image" content="http://calaccess.californiacivicdata.org/static/calaccess_website/images/brown-bear-share.png"/>
    <meta property="og:description" content="Use our open-source software to take advantage of PostgreSQL's powerful COPY TO command"/>

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:image:src" content="http://calaccess.californiacivicdata.org/static/calaccess_website/images/brown-bear-share.png">
    <meta property="twitter:site" content="@latimes">
    <meta property="twitter:title" content="How to export Django data faster than ever before">
    <meta property="twitter:description" content="Use our open-source software to take advantage of PostgreSQL's powerful COPY TO command"/>
    <meta property="twitter:image" content="http://calaccess.californiacivicdata.org/static/calaccess_website/images/brown-bear-share.png" />
    <link rel="image_src" type="image/jpeg" href="http://calaccess.californiacivicdata.org/static/calaccess_website/images/brown-bear-share.png" />
</head>
<body>
    <header>
  <nav class="container">
    <div class="row">
    <div class="col-md-12">
      <ul class="nav nav-pills">
        <li class="visible-lg-inline visible-md-inline visible-sm-inline invisible-xs-inline" style="margin-left:0;">
            <a class="logo" href="https://www.californiacivicdata.org/">
                <img
                    src="//calaccess.californiacivicdata.org/static/calaccess_website/images/brown-geobear.svg"
                    alt="California Civic Data Coalition logo"
                    title="Home"
                >
            </a>
        </li>
        <li id="home"><a href="/">HOME</a></li>
        <li id="data"><a href="https://calaccess.californiacivicdata.org/downloads/latest/">DATA</a></li>
        <li id="docs"><a href="https://calaccess.californiacivicdata.org/documentation/">DOCS</a></li>
        <li id="blog"><a href="/archive/">BLOG</a></li>
        <li id="about"><a href="/about/">ABOUT</a></li>
      </ul>
    </div>
    </div>
  </nav>
</header>

<script type="text/javascript">
    var url = window.location;
    // Will only work if string in href matches with location
    $('ul.nav a[href="' + url + '"]').parent().addClass('active');
    // Will also work for relative and absolute hrefs
    $('ul.nav a').filter(function() {
        return this.href == url;
    }).parent().addClass('active');
    $("#small-icon").css("cursor", "pointer");
    $("#small-icon").click(function () {
        window.location = '/';
    });
</script>

    <article>
    <div class="bg-red">
        <div class="container">
            <div class="row">
                <nav class="col-md-9">
                    <ol class="breadcrumb">
                        <li><a href="/">Home</a></li>
                        <li><a href="/archive/">Blog</a></li>
                    </ol>
                </nav>
                <div class="col-md-9">
                    <h1>How to export Django data faster than ever before</h1>
                    <p>
                        <p>Use our open-source software to take advantage of PostgreSQL’s powerful COPY TO command</p>

                    </p>
                    <div class="byline"><p>By <a href="http://palewi.re/who-is-ben-welsh/">Ben Welsh</a></p>
</div>
                <div class="pubdate"><p><time datetime="2017-09-05">September  5, 2017</time></p></div>
                </div>
            </div>
        </div>
    </div>
    <div class="container content">
        <div class="row">
            <div class="post col-lg-8 col-md-10 col-sm-12 col-xs-12">
                <p>Today the California Civic Data Coalition released a new open-source tool that enables the Django web framework to more quickly export comma-delimited data.</p>

<p>Version 2.0 of <a href="http://django-postgres-copy.californiacivicdata.org/en/latest/">django-postgres-copy</a>, now available on the Python Package Index, extends Django’s database tools to support PostgreSQL’s powerful <a href="https://www.postgresql.org/docs/9.2/static/sql-copy.html">COPY TO</a> command.</p>

<p>Found only in PostgreSQL, COPY TO can write out tables with millions of rows in a matter of seconds.</p>

<p>Our code, crafted by the Coalition’s Lead Developer <a href="https://twitter.com/je_gordon">James Gordon</a>, makes using it this easy:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Person</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">"/path/to/your/export.csv"</span><span class="p">)</span></code></pre></figure>

<p>The custom to_csv method does it all. To start using it yourself, all you need to do is install our library and add a <a href="https://docs.djangoproject.com/en/1.11/topics/db/managers/">custom manager</a> to your model.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">postgres_copy</span> <span class="kn">import</span> <span class="n">CopyManager</span>


<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">CopyManager</span><span class="p">()</span></code></pre></figure>

<p>Once that’s done you’re ready to roll. You can even export database queries that include filters, groups or other Django database tricks. For instance, this will work:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Person</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="s">'BEN'</span><span class="p">).</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'/path/to/your/export.csv'</span><span class="p">)</span></code></pre></figure>

<p>And so will something like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Person</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">name_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">'first_name'</span><span class="p">)).</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'/path/to/your/export.csv'</span><span class="p">)</span></code></pre></figure>

<p>In cases where your model is connected to other tables with a foreign key, you can increase the number of fields exported by listing them out and calling in related tables using Django’s double underscore notation.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Person</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span>
    <span class="s">'/path/to/your/export.csv'</span><span class="p">,</span>
    <span class="s">'first_name'</span><span class="p">,</span>
    <span class="s">'last_name'</span><span class="p">,</span>
    <span class="s">'hometown__name'</span>
<span class="p">)</span></code></pre></figure>

<h3 id="why-do-you-need-this">Why do you need this?</h3>

<p>The Coalition invented this tool as part of its open-source quest to master <a href="/about/">CAL-ACCESS</a>, the jumbled, dirty and difficult government database tracking money in California politics.</p>

<p>We are nearing the completion of a pipeline of Python code that downloads, extracts, cleans, loads, transforms and republishes the state’s raw data as easy-to-understand spreadsheets. This new wrapper for COPY TO allows our pipeline to quickly and clearly export a set of simplified flat files for end users.</p>

<h3 id="what-else-can-it-do">What else can it do?</h3>

<p>The library has long supported swiftly importing data files with PostgreSQL’s COPY command. Starting today, that old tool is easier to access with a new from_csv method on our custom manager. Code like the following can load millions of records in your database in a matter of seconds.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Person</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">from_csv</span><span class="p">(</span>
    <span class="c1"># The source file
</span>    <span class="s">"/path/to/your/import.csv"</span><span class="p">,</span>
    <span class="c1"># A crosswalk of model fields to CSV headers.
</span>    <span class="nb">dict</span><span class="p">(</span><span class="n">first_name</span><span class="o">=</span><span class="s">'FIRST_NAME'</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s">'LAST_NAME'</span><span class="p">)</span>
<span class="p">)</span></code></pre></figure>

<h3 id="what-now">What now?</h3>

<p>If you’d like to try our tool out for yourself, you can install it with Python’s <code class="language-plaintext highlighter-rouge">pip</code> like so:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>pip <span class="nb">install </span>django-postgres-copy</code></pre></figure>

<p>To learn more about how it works, visit the <a href="http://django-postgres-copy.californiacivicdata.org/">technical documentation</a>. There you’ll find a more complete explanation and information about some fancier tricks not covered here, like the capability to transform and clean data on-the-fly as it’s loaded into the database.</p>

<p>Since it was <a href="https://www.californiacivicdata.org/2015/07/17/hello-django-postgres-copy/">first released</a> in 2015, django-posgres-copy has drawn contributions from coders around the world, including some major improvements <a href="https://www.californiacivicdata.org/2016/11/14/django-postgres-copy-0.1/">from users in other fields</a>. If there are improvements you’d like to see, go get involved on <a href="https://github.com/california-civic-data-coalition/django-postgres-copy">our GitHub repository</a>.</p>

            <script type="text/javascript">
                var url = window.location;
                // Will only work if string in href matches with location
                $('ul.nav a[href="/archive/"]').parent().addClass('active');
                // Will also work for relative and absolute hrefs
                $('ul.nav a').filter(function() {
                    return this.href == url;
                }).parent().addClass('active');
                $("#small-icon").css("cursor", "pointer");
                $("#small-icon").click(function () {
                    window.location = '/';
                });
            </script>
            </div>
        </div>
    </div>
    </article>
    <footer class="footer" aria-label="Footer">
  <nav class="container">
    <div class="row icon">
      <a href="http://www.californiacivicdata.org/">
        <img src="//calaccess.californiacivicdata.org/static/calaccess_website/images/white-geobear.svg"
             alt="California Civic Data Coalition logo">
      </a>
    </div>
    <div class="row">
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-5 col-xs-offset-1">
        <h3>CAL-ACCESS</h3>
        <ul>
            <li><a href="http://calaccess.californiacivicdata.org/downloads/latest/">Latest downloads</a></li>
            <li><a href="http://calaccess.californiacivicdata.org/downloads/">Downloads archive</a></li>
            <li><a href="http://calaccess.californiacivicdata.org/documentation/">Documentation</a></li>
        </ul>
      </section>
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-4 col-xs-offset-2">
        <h3>Blog</h3>
        <ul>
          <li><a href="http://www.californiacivicdata.org/archive/">All posts</a></li>
          <li><a href="http://www.californiacivicdata.org/archive/latest.xml">RSS</a></li>
        </ul>
      </section>
      <div class="clearfix visible-sm visible-xs"></div>
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-5 col-xs-offset-1">
        <h3>About</h3>
        <ul>
          <li><a href="https://www.californiacivicdata.org/about/">Our story</a></li>
          <li><a href="https://www.californiacivicdata.org/about/#team">The team</a></li>
          <li><a href="https://www.californiacivicdata.org/about/#events">Events</a></li>
          <li><a href="https://www.californiacivicdata.org/about/#what-others-are-saying">What others are saying</a></li>
        </ul>
      </section>
      <section class="col-md-2 col-md-offset-1 col-sm-5 col-sm-offset-1 col-xs-4 col-xs-offset-2">
        <h3>Contact</h3>
        <ul>
          <li><a href="mailto:cacivicdata@gmail.com">E-mail</a></li>
          <li><a href="https://github.com/california-civic-data-coalition">GitHub</a></li>
          <li><a href="https://newsnerdery.slack.com/archives/C0H8Y2QBD">Slack</a></li>
        </ul>
      </section>
    </div>
    <section class="row xs-left">
      <p>
        &copy; <span class="easteregg"><a href="https://www.youtube.com/watch?v=wPsA3TsK1Uk">2016 'til infinity</a></span>
        <span><a href="https://www.californiacivicdata.org/">California Civic Data Coalition</a>.</span>
        <span><span class="easteregg"><a href="https://en.wikipedia.org/wiki/Gratis_versus_libre">Gratis, libre and fermented</a></span> on <a href="https://github.com/california-civic-data-coalition/">GitHub</a>.</span>
        <span class="easteregg"><a href="https://www.youtube.com/watch?v=wKgGXxoT5Ds">Westside right on time only thing fosho</a>.</span>
      </p>
    </section>
  </nav>
</footer>

</body>
</html>
